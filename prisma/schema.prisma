generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Master Data
model Supplier {
  id             String @id @default(uuid())
  name           String
  contactDetails String?
  deals          Deal[]
}

model Customer {
  id             String @id @default(uuid())
  name           String
  contactDetails String?
  defaultTerms   String?
  deals          Deal[]
}

model Financier {
  id             String @id @default(uuid())
  name           String
  fundingTerms   String?
  deals          Deal[]
}

model Commodity {
  id   String @id @default(uuid())
  name String @unique
  deals Deal[]
}

// Core Deal
model Deal {
  id String @id // Deal Note Number (e.g. RP-0008)

  date DateTime // Deal Date

  status String @default("Open") // Open, Closed, Cancelled

  // Relations
  commodityId String
  commodity   Commodity @relation(fields: [commodityId], references: [id])
  commodityGrade String? // Commodity Notes / Grade

  supplierId String
  supplier   Supplier @relation(fields: [supplierId], references: [id])

  customerId String
  customer   Customer @relation(fields: [customerId], references: [id])

  financierId String? // Nullable for self-funded
  financier   Financier? @relation(fields: [financierId], references: [id])

  // Quantity & Pricing (Inputs)
  quantity          Decimal // Transaction Tonnage (Agreed)
  supplierPricePerTon Decimal
  offtakePricePerTon  Decimal
  
  // Commercial Value Calculations (Stored for performance/sorting)
  costValue        Decimal // quantity * supplierPrice
  expectedSalesValue Decimal // quantity * offtakePrice
  expectedGrossMargin Decimal // sales - cost
  expectedMarginPercentage Decimal // gross / sales
  
  // Terms & Control
  paymentTermsCustomer Int? // Days
  paymentTermsFinancier Int? // Days
  dealOwner String? // User name/ID
  comments String?

  // Modules
  loan             Loan? // One loan per deal
  deliveries       Delivery[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Loan {
  id String @id @default(uuid())
  dealId String @unique
  deal   Deal   @relation(fields: [dealId], references: [id])
  
  principal      Decimal
  disbursementDate DateTime
  maturityDate   DateTime
  paymentTerms   Int // Days
  repaymentAmount Decimal // Principal + Margin
  
  status String @default("Open") // Open, Closed
  
  repayments Repayment[]
}

model Repayment {
  id String @id @default(uuid())
  loanId String
  loan   Loan @relation(fields: [loanId], references: [id])
  
  date DateTime
  amount Decimal
  method String // Cash, Nostro
}

model Delivery {
  id String @id @default(uuid())
  dealId String
  deal   Deal   @relation(fields: [dealId], references: [id])
  
  date DateTime
  quantity Float
  invoiceNumber String
  invoiceAmount Decimal
  
  status String @default("Unpaid") // Paid, Part Paid, Unpaid
  
  payments CustomerPayment[]
}

model CustomerPayment {
  id String @id @default(uuid())
  deliveryId String
  delivery   Delivery @relation(fields: [deliveryId], references: [id])
  
  date DateTime
  amount Decimal
  method String
}

model CashBook {
  id String @id @default(uuid())
  date DateTime
  description String
  dealId String? // Optional link to deal
  
  category String // "Loan Received", "Supplier Payment", "Customer Receipt", "Loan Repayment"
  
  // Flat columns for manual entry
  cashIn   Decimal @default(0)
  cashOut  Decimal @default(0)
  bankIn   Decimal @default(0)
  bankOut  Decimal @default(0)

  createdAt DateTime @default(now())
}
